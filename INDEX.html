<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ora User Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        .hidden { display: none; }
        .plan-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .plan-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .popular-badge {
            position: absolute;
            top: -8px;
            right: 16px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            transform: rotate(3deg);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login/Register Page -->
    <div id="authPage" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Ora Dashboard</h1>
            
            <!-- Login Form -->
            <div id="loginForm" class="">
                <h2 class="text-xl font-semibold mb-4 text-center">Login</h2>
                <form id="loginFormElement">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="loginEmail" required 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="loginPassword" required 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <button type="submit" 
                            class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        Login
                    </button>
                </form>
                <p class="mt-4 text-center text-sm text-gray-600">
                    Don't have an account? 
                    <button id="showRegister" class="text-blue-500 hover:text-blue-700 font-semibold">Register</button>
                </p>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Register</h2>
                <form id="registerFormElement">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Full Name</label>
                        <input type="text" id="registerName" required 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="registerEmail" required 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="registerPassword" required 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <button type="submit" 
                            class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        Register
                    </button>
                </form>
                <p class="mt-4 text-center text-sm text-gray-600">
                    Already have an account? 
                    <button id="showLogin" class="text-blue-500 hover:text-blue-700 font-semibold">Login</button>
                </p>
            </div>
            
            <div id="authError" class="mt-4 text-red-500 text-sm hidden"></div>
            <div id="authSuccess" class="mt-4 text-green-500 text-sm hidden"></div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-gray-900">Ora Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-100 px-3 py-1 rounded-full">
                            <span class="text-blue-800 font-semibold" id="userCredits">0 Credits</span>
                        </div>
                        <span id="userName" class="text-gray-700"></span>
                        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- User Info Card -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-lg font-semibold mb-2">Welcome back!</h2>
                <p class="text-gray-600">Manage your subscription plans and track your usage below.</p>
            </div>

            <!-- Subscription Plans -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-2xl font-bold mb-6 text-center">Choose Your Plan</h2>
                <div id="plansContainer" class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Plans will be loaded here -->
                </div>
                <div id="loadingPlans" class="text-center py-8 text-gray-500">
                    Loading plans...
                </div>
            </div>

            <!-- Payment Confirmation Section -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Already Paid?</h2>
                <p class="text-gray-600 mb-4">If you've completed your payment, confirm it here to get your credits added.</p>
                
                <div class="max-w-md">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Select Plan You Purchased</label>
                        <select id="purchasedPlan" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="">-- Select a plan --</option>
                        </select>
                    </div>
                    <button id="confirmPaymentBtn" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        I Paid - Confirm Purchase
                    </button>
                </div>
                
                <div id="paymentError" class="mt-4 text-red-500 text-sm hidden"></div>
                <div id="paymentSuccess" class="mt-4 text-green-500 text-sm hidden"></div>
            </div>
        </main>
    </div>

    <script>
        // Configuration - Loaded from config.js
        const SUPABASE_URL = window.appConfig.SUPABASE_URL;
        const SUPABASE_ANON_KEY = window.appConfig.SUPABASE_ANON_KEY;
        
        // Validate configuration
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            console.error('Supabase configuration missing. Please check your config.js file.');
            alert('Configuration error: Supabase credentials not found. Please check your configuration.');
        }
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global variables
        let currentUser = null;
        let availablePlans = [];

        // DOM elements
        const authPage = document.getElementById('authPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const loginFormElement = document.getElementById('loginFormElement');
        const registerFormElement = document.getElementById('registerFormElement');
        const authError = document.getElementById('authError');
        const authSuccess = document.getElementById('authSuccess');
        const userName = document.getElementById('userName');
        const userCredits = document.getElementById('userCredits');
        const logoutBtn = document.getElementById('logoutBtn');
        const plansContainer = document.getElementById('plansContainer');
        const loadingPlans = document.getElementById('loadingPlans');
        const purchasedPlan = document.getElementById('purchasedPlan');
        const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
        const paymentError = document.getElementById('paymentError');
        const paymentSuccess = document.getElementById('paymentSuccess');

        // Event listeners
        showRegister.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            hideMessages();
        });

        showLogin.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            hideMessages();
        });

        loginFormElement.addEventListener('submit', handleLogin);
        registerFormElement.addEventListener('submit', handleRegister);
        logoutBtn.addEventListener('click', handleLogout);
        confirmPaymentBtn.addEventListener('click', confirmPayment);

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                showDashboard();
                loadUserData();
                loadPlans();
            } catch (error) {
                showError(authError, 'Login failed: ' + error.message);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });
                
                if (error) throw error;
                
                showSuccess(authSuccess, 'Registration successful! Please check your email to verify your account.');
            } catch (error) {
                showError(authError, 'Registration failed: ' + error.message);
            }
        }

        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                showAuth();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Dashboard functions
        function showDashboard() {
            authPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            hideMessages();
        }

        function showAuth() {
            dashboardPage.classList.add('hidden');
            authPage.classList.remove('hidden');
            hideMessages();
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                userName.textContent = data.full_name || currentUser.email;
                userCredits.textContent = `${data.api_credits} Credits`;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadPlans() {
            try {
                const { data, error } = await supabase
                    .from('subscription_plans')
                    .select('*')
                    .eq('is_active', true)
                    .order('current_price');
                
                if (error) throw error;
                
                availablePlans = data || [];
                displayPlans(availablePlans);
                populatePlanDropdown(availablePlans);
                hideLoading();
            } catch (error) {
                console.error('Error loading plans:', error);
                hideLoading();
            }
        }

        function displayPlans(plans) {
            plansContainer.innerHTML = plans.map(plan => {
                const discount = plan.original_price > plan.current_price ? 
                    Math.round((1 - plan.current_price / plan.original_price) * 100) : 0;
                
                return `
                    <div class="plan-card relative bg-white border-2 ${plan.is_popular ? 'border-orange-400' : 'border-gray-200'} rounded-lg p-6 text-center">
                        ${plan.is_popular ? '<div class="popular-badge">POPULAR</div>' : ''}
                        <h3 class="text-xl font-bold mb-2">${plan.name}</h3>
                        <p class="text-gray-600 mb-4 h-12">${plan.description}</p>
                        <div class="mb-4">
                            ${plan.original_price > plan.current_price ? 
                                `<span class="text-lg text-gray-500 line-through">₹${plan.original_price}</span>` : ''}
                            <div class="text-3xl font-bold text-blue-600">₹${plan.current_price}</div>
                            ${discount > 0 ? `<span class="text-green-600 font-semibold">${discount}% OFF</span>` : ''}
                        </div>
                        <div class="text-lg font-semibold mb-4 text-gray-800">${plan.credits_included} Credits</div>
                        <a href="${plan.payment_link}" target="_blank" 
                           class="block w-full ${plan.is_popular ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-500 hover:bg-blue-600'} text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                            Buy Now
                        </a>
                    </div>
                `;
            }).join('');
        }

        function populatePlanDropdown(plans) {
            const options = plans.map(plan => 
                `<option value="${plan.id}">${plan.name} - ₹${plan.current_price}</option>`
            ).join('');
            purchasedPlan.innerHTML = '<option value="">-- Select a plan --</option>' + options;
        }

        async function confirmPayment() {
            const selectedPlanId = purchasedPlan.value;
            if (!selectedPlanId) {
                showError(paymentError, 'Please select a plan');
                return;
            }
            
            const selectedPlan = availablePlans.find(p => p.id === selectedPlanId);
            if (!selectedPlan) {
                showError(paymentError, 'Invalid plan selected');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('payment_confirmations')
                    .insert({
                        user_id: currentUser.id,
                        plan_id: selectedPlan.id,
                        plan_name: selectedPlan.name,
                        amount_paid: selectedPlan.current_price,
                        credits_to_add: selectedPlan.credits_included,
                        user_email: currentUser.email
                    });
                
                if (error) throw error;
                
                showSuccess(paymentSuccess, 'Payment confirmation submitted! An admin will review and credit your account soon.');
                purchasedPlan.value = '';
                hideError(paymentError);
            } catch (error) {
                showError(paymentError, 'Failed to submit payment confirmation: ' + error.message);
            }
        }

        // Utility functions
        function hideLoading() {
            loadingPlans.classList.add('hidden');
        }

        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(element) {
            element.classList.add('hidden');
        }

        function showSuccess(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideMessages() {
            hideError(authError);
            hideError(authSuccess);
            hideError(paymentError);
            hideError(paymentSuccess);
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Ora User Dashboard loaded');
            
            // Check if user is already logged in
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showDashboard();
                loadUserData();
                loadPlans();
            }
            
            // Listen for auth changes
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    showDashboard();
                    loadUserData();
                    loadPlans();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    showAuth();
                }
            });
        });
    </script>
</body>
</html>